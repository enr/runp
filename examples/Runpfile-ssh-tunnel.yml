name: Test Runpfile
description: Runpfile to test SSH tunneling
units:
  tunnel:
    description: SSH tunnel to target using jump
    ssh_tunnel:
      user: runp
      auth:
        # Path to the private key
        identity_file: ~/tmp/runpssh/ssh/runp
        # The ssh server password in plain text
        #secret: "xxx"
        # The ssh server password encrypted and in base 64
        #encrypted_secret: "O7RtX8dooQXihQRKIK6nC/8okI38LOwNBoSAMrhFwpw="
      local:
        port: 8001
      jump:
        host: localhost
        port: 2222
      target:
        host: target
        port: 8000
  jump:
    description: The jump server
    container:
      name: sshserver
      image: docker.io/panubo/sshd:1.3.0
      ports:
        - "2222:22"
      volumes:
        - "{{vars runp_workdir}}/testdata/keys/runp.pub:/etc/authorized_keys/runp:ro"
        - "{{vars runp_workdir}}/testdata/ssh/sshd_config:/etc/ssh/sshd_config"
        - "{{vars runp_workdir}}/testdata/ssh/keys/:/etc/ssh/keys"
        - "{{vars runp_workdir}}/testdata/ssh/data/:/data/"
      env:
        SSH_USERS: "runp:1000:1001"
        TCP_FORWARDING: true
        SSH_ENABLE_PASSWORD_AUTH: true
  target:
    description: The target server
    container:
      name: target
      image: crccheck/hello-world
      ports:
        - "8000:8000"
  curl:
    description: curl
    host:
      # points to "local" endpoint
      command: "curl http://localhost:8001"
      await:
        resource: "http://localhost:8001"
        timeout: 0h0m5s